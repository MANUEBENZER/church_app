{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% load role_tags %}

<!-- TEMPLATE LOADED: add_attendance.html -->

{% block content %}
<!-- External Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Local Assets -->
<link rel="stylesheet" href="{% static 'css/add_attendance.css' %}">
<script src="{% static 'js/add_attendance.js' %}"></script> 

<!-- Page Title -->
<h2>
    Mark Attendance for {{ service_type }} – {{ today }}
    <small style="color:#777;">
        ({{ selected_date|date:"D, d M Y" }})
    </small>
</h2>

<form method="get" class="date-picker-form">
    <input type="hidden" name="service" value="{{ service_type }}">

    <label for="attendance-date"><strong>Select Date:</strong></label>

    <input
        type="date"
        id="attendance-date"
        name="date"
        value="{{ selected_date|date:'Y-m-d' }}"
        max="{{ today|date:'Y-m-d' }}"
        onchange="this.form.submit()"
    >
</form>




<!-- =========================
     SERVICE SELECTION
========================= -->
<div class="service-select">
    <a href="?service=Sunday">
        <button class="{% if service_type == 'Sunday' %}active{% endif %}">Sunday</button>
    </a>

    <a href="?service=Midweek">
        <button class="{% if service_type == 'Midweek' %}active{% endif %}">Midweek</button>
    </a>

    <a href="?service=Prayers">
        <button class="{% if service_type == 'Prayers' %}active{% endif %}">Prayers</button>
    </a>

    <a href="?service=Prayer Meeting">
        <button class="{% if service_type == 'Prayer Meeting' %}active{% endif %}">
            Prayer Meeting
        </button>
    </a>

    <a href="?service=Bible Study">
        <button class="{% if service_type == 'Bible Study' %}active{% endif %}">
            Bible Study
        </button>
    </a>

    <a href="?service=Intercessory Prayer">
        <button class="{% if service_type == 'Intercessory Prayer' %}active{% endif %}">
            Intercessory Prayer
        </button>
    </a>

    <a href="?service=Special Prayer Campaign">
        <button class="{% if service_type == 'Special Prayer Campaign' %}active{% endif %}">
            Special Prayer Campaign
        </button>
    </a>

    <a href="?service=Youth Prayer Gathering">
        <button class="{% if service_type == 'Youth Prayer Gathering' %}active{% endif %}">
            Youth Prayer Gathering
        </button>
    </a>

    <a href="?service=Prayer and Testimony">
        <button class="{% if service_type == 'Prayer and Testimony' %}active{% endif %}">
            Prayer and Testimony
        </button>
    </a>
</div>

<!-- =========================
     SEARCH BAR
========================= -->
<form method="get" class="search-bar">
    <input type="hidden" name="service" value="{{ service_type }}">
    <input
        type="text"
        name="q"
        placeholder="Search members..."
        value="{{ search_query }}"
    >
    <button type="submit">Search</button>
</form>

<!-- =========================
     ATTENDANCE TABLE
========================= -->
<div style="margin-bottom:10px;">
    <button id="mark-all" class="btn-mark-all">
        Mark All Present
    </button>
</div>


<table>
    <thead>
        <tr>
            <th>Mark</th>
            <th>Photo</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Gender</th>
            <th>Past Attendance</th>
            <th>th</th>
            <th>% Attendance</th>
        </tr>
    </thead>

<tbody>
{% for member in members %}
<tr class="{% if member.id in present_member_ids %}present-row{% else %}absent-row{% endif %}">

    <td style="text-align:center;">
        <input
            type="checkbox"
            class="attendance-checkbox"
            data-member="{{ member.id }}"
            data-service="{{ service_type }}"
            data-date="{{ selected_date|date:'Y-m-d' }}"
            {% if member.id in present_member_ids %}checked{% endif %}
            {% if is_locked %}disabled{% endif %}
        >
    </td>

    <td>
        <img
            src="{% if member.photo %}{{ member.photo.url }}{% else %}{% static 'img/default_user.png' %}{% endif %}"
            class="member-photo"
        >
    </td>

    <td>{{ member.full_name }}</td>
    <td>{{ member.phone }}</td>
    <td>{{ member.gender }}</td>

    <td>
        {% for att in member.attendance_set.all|slice:"-5:" %}
            {{ att.date }} : {{ att.present|yesno:"✔,✖" }}<br>
        {% empty %}
            <em>No records</em>
        {% endfor %}
    </td>

    <td>{{ member.attendance_percentage }}%</td>

</tr>
{% endfor %}
</tbody>


</table>

<!-- =========================
     CSRF TOKEN (AJAX)
========================= -->
<form id="csrf-form" style="display:none;">
    {% csrf_token %}
</form>

<!-- =========================
     ATTENDANCE SUMMARY
========================= -->
<h4>Attendance Summary</h4>
<ul>
    <li>Present: <span id="present-count">{{ attendance_summary.total_present }}</span></li>
    <li>Absent: <span id="absent-count">{{ attendance_summary.total_absent }}</span></li>
    <li>Total: <span id="total-count">{{ attendance_summary.total_members }}</span></li>
</ul>


<p>
    <strong>Total Attendance (Auto):</strong>
    {{ report.total_attendance }}
</p>

{% endblock %}
